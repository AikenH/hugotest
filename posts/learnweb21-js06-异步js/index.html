<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>LearnWeb21-JS06-异步JS | aiken's blog</title>
<meta name=keywords content="NotDone"><meta name=description content="
  
    
      
    
    Summary
  
  如果页面的功能较为复杂，且涉及到了从服务端获取数据等操作，如果简单的使用同步编程，等待一个个任务按顺序执行，由于网络或者某些时间复杂度较高的操作，导致网页加载时间过长，或者使用逻辑不合理（加载某些资源的同时无法进行浏览等），因此异步编程的特性在 web 端是十分重要的。


通过异步编程使一个长时间运行的任务运行的同时能够对网页做出其他的操作和对其他事件做出相应，而不需等待该任务完成，以下的这些功能就是最常见需要异步完成的；

fetch 发起 http 请求
getUserMedia() 获取用户的摄像头和麦克风
showOpenFilePicker() 请求用户选择文件以供访问。

基于事件处理程序实现异步

事件处理的逻辑实际上也是一种接近异步编程的方式，对应的函数不是即时执行，而是等事件被触发后在进行调用。一些早期的异步 API 就是这样使用事件的。"><meta name=author content="aikenhong"><link rel=canonical href=https://aikenh.cn/hugotest/posts/learnweb21-js06-%E5%BC%82%E6%AD%A5js/><link crossorigin=anonymous href=/hugotest/assets/css/stylesheet.2f85ca17c12c62fa86b1e474b8a51aca4856f0d645debfe4922a4d5ddc6aa978.css integrity="sha256-L4XKF8EsYvqGseR0uKUaykhW8NZF3r/kkipNXdxqqXg=" rel="preload stylesheet" as=style><link rel=icon href=https://aikenh.cn/favicon/ghost.ico><link rel=icon type=image/png sizes=16x16 href=https://aikenh.cn/favicon/ghost-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aikenh.cn/favicon/ghost-32x32.png><link rel=apple-touch-icon href=https://aikenh.cn/favicon/ghost-apple-touch-icon.png><link rel=mask-icon href=https://aikenh.cn/favicon/ghost-192x192.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://aikenh.cn/hugotest/posts/learnweb21-js06-%E5%BC%82%E6%AD%A5js/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=https://cdn.jsdmirror.com/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdmirror.com/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdmirror.com/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><link rel=stylesheet href=https://cdn.jsdmirror.com/npm/katex@0.16.11/dist/katex.min.css><script defer src=https://cdn.jsdmirror.com/npm/katex@0.16.11/dist/katex.min.js></script><script defer src=https://cdn.jsdmirror.com/npm/katex@0.16.11/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet href=https://cdn.jsdmirror.com/npm/lxgw-wenkai-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdmirror.com/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdmirror.com/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css><link rel=stylesheet href=https://cdn.jsdmirror.com/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel=stylesheet><meta property="og:url" content="https://aikenh.cn/hugotest/posts/learnweb21-js06-%E5%BC%82%E6%AD%A5js/"><meta property="og:site_name" content="aiken's blog"><meta property="og:title" content="LearnWeb21-JS06-异步JS"><meta property="og:description" content="Summary如果页面的功能较为复杂，且涉及到了从服务端获取数据等操作，如果简单的使用同步编程，等待一个个任务按顺序执行，由于网络或者某些时间复杂度较高的操作，导致网页加载时间过长，或者使用逻辑不合理（加载某些资源的同时无法进行浏览等），因此异步编程的特性在 web 端是十分重要的。
通过异步编程使一个长时间运行的任务运行的同时能够对网页做出其他的操作和对其他事件做出相应，而不需等待该任务完成，以下的这些功能就是最常见需要异步完成的；
fetch 发起 http 请求 getUserMedia() 获取用户的摄像头和麦克风 showOpenFilePicker() 请求用户选择文件以供访问。 基于事件处理程序实现异步 事件处理的逻辑实际上也是一种接近异步编程的方式，对应的函数不是即时执行，而是等事件被触发后在进行调用。一些早期的异步 API 就是这样使用事件的。"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-01T06:22:33+00:00"><meta property="article:modified_time" content="2024-05-01T06:22:33+00:00"><meta property="article:tag" content="NotDone"><meta property="og:image" content="https://aikenh.cn/cover/cover12.jpeg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aikenh.cn/cover/cover12.jpeg"><meta name=twitter:title content="LearnWeb21-JS06-异步JS"><meta name=twitter:description content="
  
    
      
    
    Summary
  
  如果页面的功能较为复杂，且涉及到了从服务端获取数据等操作，如果简单的使用同步编程，等待一个个任务按顺序执行，由于网络或者某些时间复杂度较高的操作，导致网页加载时间过长，或者使用逻辑不合理（加载某些资源的同时无法进行浏览等），因此异步编程的特性在 web 端是十分重要的。


通过异步编程使一个长时间运行的任务运行的同时能够对网页做出其他的操作和对其他事件做出相应，而不需等待该任务完成，以下的这些功能就是最常见需要异步完成的；

fetch 发起 http 请求
getUserMedia() 获取用户的摄像头和麦克风
showOpenFilePicker() 请求用户选择文件以供访问。

基于事件处理程序实现异步

事件处理的逻辑实际上也是一种接近异步编程的方式，对应的函数不是即时执行，而是等事件被触发后在进行调用。一些早期的异步 API 就是这样使用事件的。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://aikenh.cn/hugotest/posts/"},{"@type":"ListItem","position":2,"name":"LearnWeb21-JS06-异步JS","item":"https://aikenh.cn/hugotest/posts/learnweb21-js06-%E5%BC%82%E6%AD%A5js/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"LearnWeb21-JS06-异步JS","name":"LearnWeb21-JS06-异步JS","description":"\rSummary\r如果页面的功能较为复杂，且涉及到了从服务端获取数据等操作，如果简单的使用同步编程，等待一个个任务按顺序执行，由于网络或者某些时间复杂度较高的操作，导致网页加载时间过长，或者使用逻辑不合理（加载某些资源的同时无法进行浏览等），因此异步编程的特性在 web 端是十分重要的。\n通过异步编程使一个长时间运行的任务运行的同时能够对网页做出其他的操作和对其他事件做出相应，而不需等待该任务完成，以下的这些功能就是最常见需要异步完成的；\nfetch 发起 http 请求 getUserMedia() 获取用户的摄像头和麦克风 showOpenFilePicker() 请求用户选择文件以供访问。 基于事件处理程序实现异步 事件处理的逻辑实际上也是一种接近异步编程的方式，对应的函数不是即时执行，而是等事件被触发后在进行调用。一些早期的异步 API 就是这样使用事件的。\n","keywords":["NotDone"],"articleBody":"\rSummary\r如果页面的功能较为复杂，且涉及到了从服务端获取数据等操作，如果简单的使用同步编程，等待一个个任务按顺序执行，由于网络或者某些时间复杂度较高的操作，导致网页加载时间过长，或者使用逻辑不合理（加载某些资源的同时无法进行浏览等），因此异步编程的特性在 web 端是十分重要的。\n通过异步编程使一个长时间运行的任务运行的同时能够对网页做出其他的操作和对其他事件做出相应，而不需等待该任务完成，以下的这些功能就是最常见需要异步完成的；\nfetch 发起 http 请求 getUserMedia() 获取用户的摄像头和麦克风 showOpenFilePicker() 请求用户选择文件以供访问。 基于事件处理程序实现异步 事件处理的逻辑实际上也是一种接近异步编程的方式，对应的函数不是即时执行，而是等事件被触发后在进行调用。一些早期的异步 API 就是这样使用事件的。\n一些早期的异步 API 就是这样来使用事件，例如 XMLHttpRequest 可以使用 JS 向远程服务器发起 HTTP 请求，这类网络请求操作都会比较耗时，因此通常会使用异步，以下面的例子进行后续说明；\n1 2 3 4 5 6 7 8 9 10 11 12 const log = document.querySelector(\".event-log\"); document.querySelector(\"#xhr\").addEventListener）(\"click\", () =\u003e { log.textContent = \"\"; const xhr = new XMLHttpRequest(); xhr.addEvenetLister(\"loadend\", () =\u003e { log.textContent = `${log.textContent} 完成, 状态码: ${xhr.status}`; }); xhr.open(\"GET\", \"https://URL/dir/file.json\"); xhr.send(): log.textContent = `${log.textContent} 请求已发起\\n`; }); xhr 按钮点击后，声明一个 XMLHttpRequest 对象，并监听其 loadend 事件，然后发送请求，并将字符串修改为请求已发起，该字符串会在触发了 loadend 加载完了请求事件后改为，已完成。\n事件处理程序本身是一种特殊类型的回调函数（函数作为参数传递到另一个函数），多层回调函数的嵌套会导致代码难以理解和 debug，因此后面大多数 API 不在使用回调函数去处理异步的情况。\nPromise 现代 JS 异步编程的基础 Promise 是现代 JavaScript 中异步编程的基础。它是一个由异步函数返回的对象，可以指示操作当前所处的状态。在 Promise 返回给调用者的时候，操作往往还没有完成，但 Promise 对象提供了方法来处理操作最终的成功或失败。\n一个基于 Promise 的 API，异步函数会启动操作并直接返回一个 Promise 对象，可以将后续的处理函数附加到该对象上，当操作完成时（成功、失败），执行对应的处理函数。\n以 fetch() 为例 1 2 3 4 5 6 7 8 9 10 const fetchPromise = fetch( \"https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json\", ); console.log(fetchPromise); fetchPromise.then((response) =\u003e { console.log(`已受到响应 ${response.status}`); }); console.log(\"已发送请求...\"); 1 Promise { : \"pending\"} 调用 fetch() 将返回的 promise 存储到 fetchPromise 变量 Promise 的变量输出结果如下 将处理函数传递给 promise 变量的 then 函数，当 fetch 操作成功的时候，promise 就会调用对应的处理函数。 整体的处理逻辑还是比较清晰的，关键是使用 promise 变量的 then 函数去处理 fetch 的各种不同结果。\n链式使用 Promise 在前面通过 fetch 获取 response 对象的时候，我们需要使用对应的 json() 方法将其转换为 js 专属的对象，这里的 json 实际上也是一个异步方法，由此我们可以链式的实现异步如下：\n1 2 3 4 5 6 7 8 9 10 const fetchPromise = fetch( \"https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json\", ); fetchPromisze.then((response) =\u003e { const jsonPromise = response.json(); jsonPromise.then((json) =\u003e { console.log(json[0].name); }); }); 这种情况在多层嵌套的时候也会堆叠得很难理解，但是相比于回调函数，每一级的回调都会有个 promise 的即时返回值来指示对应异步函数中的完成状态。\n由于 promise 是一个即时返回值，因此上述的代码可以简写为：\n1 2 3 4 5 fetchPromise .then((response) =\u003e response.json()) .then((data) =\u003e { console.log(data[0].name); }); 不必在第一个 then 中调用下一个 then，可以直接返回对应的 promise 对象，对对应的 promise 对象调用处理即可，这样可以避免多级缩进叠加；\n处理异常返回值 对 promise 中的状态值进行检查，如果状态码不是 ok 就需要对应的抛出错误：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 const fetchPromise = fetch( \"https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json\", ); fetchPromise .then((response) =\u003e { if(!response.ok){ throw new Error(`HTTP 请求错误 ${response.status}`); } }) .then((json) =\u003e { console.log(json[0].name); }); 此外由于这种异步的函数返回机制，如果要按照上面的方式逐个进行错误处理非常的困难，需要在每个嵌套层中进行处理，为了避免这种麻烦，Promise 对象提供了一个 catch() 方法（类似 then），当调用成功时触发的是 then 而调用失败了就会调用 catch 中定义的处理函数。\n将 catch 添加到 Promise 的末尾，他可以在任何异步函数失败的时候调用，下面是一个例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 const fetchPromise = fetch( \"bad-scheme://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json\", ); fetchPromise .then((response) =\u003e { if (!response.ok) { throw new Error(`HTTP 请求错误：${response.status}`); } return response.json(); }) .then((json) =\u003e { console.log(json[0].name); }) .catch((error) =\u003e { console.error(`无法获取产品列表：${error}`); }); Promise 的状态值 需要注意 promise 对应的成功和失败的含义随着 API 的不同而不同，例如 fetch 认为服务器返回一个错误如（404 not found）时请求成功，但如果网络错误阻止请求被发送，则认为请求失败。\nStatus Desc Pending 待定 还在请求中，尚未有确定的结果，也是初始状态 fulfilled 已兑现 操作成功的标准返回，后续进入调用 then 的逻辑 rejected 已拒绝 操作失败的标准返回，后续进入调用 catch 的逻辑 有时用**已敲定(settled)来同时表示已兑现和已拒绝；如果一个 Promise 已敲定，或者他被\"锁定\"以跟踪另一个 Promise 的状态，那么就是已解决(resolved)**的。\n组式使用 Promise (合并使用) 当操作由多个异步函数组成，如果需要串行完成那就需要 promise 链，如果需要组合使用多个 promise，相互之间不依赖但是需要所有 promise 都实现的情况，可以考虑合并多个异步函数的使用。\n使用 Promise.all() 接受一个 Promise 数组，并返回一个单一的 Promise，使用该操作通过合并来简化对一批 promise 的处理，由 promise.all() 返回的 promise 有以下的特性：\n什么时候调用 then？当数组中所有 promise 都兑现时; 传入 then 的形式式什么？提供一个包含所有响应的数组，顺序与传入 all 的顺序一致; 什么时候拒绝/调用catch？任何一个promise 没有兑现的时候，调用 catch，并提供被拒绝的 promise 抛出的错误; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 const fetchPromise1 = fetch( \"https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json\", ); const fetchPromise2 = fetch( \"https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/not-found\", ); const fetchPromise3 = fetch( \"https://mdn.github.io/learning-area/javascript/oojs/json/superheroes.json\", ); //const fetchPromise3 = fetch( // \"bad-scheme://mdn.github.io/learning-area/javascript/oojs/json/superheroes.json\", //); Promise.all([fetchPromise1, fetchPromise2, fetchPromise3]) .then((responses) =\u003e { for (const response of responses) { console.log(`${response.url}：${response.status}`); } }) .catch((error) =\u003e { console.error(`获取失败：${error}`); }); 选择使用 Promise (任一) 如果需要一组Promise 中某一个实现即可，这种时候可以使用 promise.any(), 任意一个被兑现时便兑现，仅当所有 Promise 被拒绝的时候才拒绝。\nasync 和 await 在函数的开头添加 async 关键词可以使得一个函数成为一个异步函数：\n1 2 3 async function myFunction(){ ... } await 关键词则使得我们不再并行执行异步函数，而是在原地等待该异步函数执行完成，也就是讲异步函数当成同步函数来使用，直到其 Promise 相应彻底完成，如下可以将 fetch 改写成同步函数：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 async function fetchProducts() { try { // 在这一行之后，我们的函数将等待 `fetch()` 调用完成 // 调用 `fetch()` 将返回一个“响应”或抛出一个错误 const response = await fetch( \"https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json\", ); if (!response.ok) { throw new Error(`HTTP 请求错误：${response.status}`); } // 在这一行之后，我们的函数将等待 `response.json()` 的调用完成 // `response.json()` 调用将返回 JSON 对象或抛出一个错误 const json = await response.json(); console.log(json[0].name); } catch (error) { console.error(`无法获取产品列表：${error}`); } } fetchProducts(); 这个 fetchProducts() 还是一个异步函数，因此不能按照以下的方法调用：\n1 2 const promise = fetchProducts(); console.log(promise[0].name); // “promise”是一个 Promise 对象，因此这句代码无法正常工作 相反的，需要按照 promise 的方式去调用：\n1 2 const promise = fetchProducts(); promise.then((data) =\u003e console.log(data[0].name)); 同样地，请注意你只能在 async 函数中使用 await，除非你的代码是 JavaScript 模块 。这意味着你不能在普通脚本中这样做：\n你可能会在需要使用 Promise 链地方使用 async 函数，这也使得 Promise 的工作更加直观。\n请记住，就像一个 Promise 链一样，await 强制异步操作以串联的方式完成。如果下一个操作的结果取决于上一个操作的结果，这是必要的，但如果不是这样，像 Promise.all() 这样的操作会有更好的性能。\nPromise 实战 前面讨论如何使用返回 promise 的 APIs，这一节研究如何实现返回 Promise 的 Apis，这与基于使用 promise 的 APIs 相比，是一个不太常见的任务。参考文献 mdn如何实现基于promise的api | 菜鸟教程JavaScript Promise | 廖雪峰JavaScript 以一个普通的回调转换为 Promise 的例子来说明：\n1 2 3 4 5 6 7 8 9 10 const output = document.querySelector(\"#output\"); const button = document.querySelector(\"#set-alarm\"); function setAlarm() { window.setTimeout(() =\u003e { output.textContent = \"Wake up!\"; }, 1000); } button.addEventListener(\"click\", setAlarm); 利用 Promise 来构造后会变成如下的实现：\n1 2 3 4 5 6 7 8 9 10 function alarm(person, delay) { return new Promise((resolve, reject) =\u003e { if (delay \u003c 0) { throw new Error(\"Alarm delay must not be negative\"); } window.setTimeout(() =\u003e { resolve(`Wake up, ${person}!`); }, delay); }); } 该函数会创建并返回一个新的 Promise，其中需要说明的是，Promise 本身需要两个参数 resolve 和 reject，当执行成功了就会调用 resolve（类似 return），如果失败了，就会自动调用 reject，（throw error 的部分），两者都可以讲任何类型的单个参数传递，具体而言参考后续调用如下：\n1 2 3 4 5 button.addEventListener(\"click\", () =\u003e { alarm(name.value, delay.value) .then((message) =\u003e (output.textContent = message)) .catch((error) =\u003e (output.textContent = `Couldn't set alarm: ${error}`)); }); 可以讲一个函数变成具备原生异步功能的 Promise？由此我们就可以对其使用 await 或者 async 来灵活的决定该 Function 要同步或者异步执行。\nWorkers 页面线程简介 Summary\rWorker 使页面能在单独执行的线程中运行一些任务，避免因为一个长期运行的同步任务使整个任务完全没有响应。\n一些多线程的 Principle，避免同时访问相同的变量带来的意外等：\n主代码和你的 worker 代码永远不能直接访问彼此的变量 Workers 和主代码运行在完全分离的环境中，只有通过相互发送消息来进行交互 这意味着 workers 不能访问 DOM（窗口、文档、页面元素等等） 有三种不同类型的 workers，不过该章节只会介绍第一个，其他两个简要的讨论。\ndedicated workers shared workers service workers 以页面中的质数生成器为例，如果作为同步任务执行，在计算过程中整个页面将会卡住，按照以下的方式来讲计算交付于另一个 worker。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // 在 \"generate.js\" 中创建一个新的 worker const worker = new Worker(\"./generate.js\"); // 当用户点击 \"Generate primes\" 时，给 worker 发送一条消息。 // 消息中的 command 属性是 \"generate\", 还包含另外一个属性 \"quota\"，即要生成的质数。 document.querySelector(\"#generate\").addEventListener(\"click\", () =\u003e { const quota = document.querySelector(\"#quota\").value; worker.postMessage({ command: \"generate\", quota: quota, }); }); // 当 worker 给主线程回发一条消息时，为用户更新 output 框，包含生成的质数（从 message 中获取）。 worker.addEventListener(\"message\", (message) =\u003e { document.querySelector(\"#output\").textContent = `Finished generating ${message.data} primes!`; }); document.querySelector(\"#reload\").addEventListener(\"click\", () =\u003e { document.querySelector(\"#user-input\").value = 'Try typing in here immediately after pressing \"Generate primes\"'; document.location.reload(); }); 通过 worker.postMessage 来和对应的线程传递信息，在对应的 worker 中，可以按照以下的方式来接受和传递信息；\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // 监听主线程中的消息。 // 如果消息中的 command 是 \"generate\"，则调用 `generatePrimse()` addEventListener(\"message\", (message) =\u003e { if (message.data.command === \"generate\") { generatePrimes(message.data.quota); } }); // 生成质数 (非常低效) function generatePrimes(quota) { function isPrime(n) { for (let c = 2; c \u003c= Math.sqrt(n); ++c) { if (n % c === 0) { return false; } } return true; } const primes = []; const maximum = 1000000; while (primes.length \u003c quota) { const candidate = Math.floor(Math.random() * (maximum + 1)); if (isPrime(candidate)) { primes.push(candidate); } } // 完成后给主线程发送一条包含我们生成的质数数量的消息消息。 postMessage(primes.length); } worker 要做的第一件事情就是开始监听来自主脚本的消息。这通过使用 addEventListener() 实现，它在 worker 中是一个全局函数。在 message 事件处理器内部，事件的 data 属性包含一个来自主脚本的参数的副本。\nNote\r**备注：**要运行此站点，你必须运行一个本地 web 服务器，因为 file:// URLs 不允许加载 workers。参考我们的设置一个本地测试服务器 的指导。完成后，你应该可以点击 “Generate primes” 并且使你的主页面保持响应。 如果你在创建和运行这个样例的过程中有疑问，你可以在 https://github.com/mdn/learning-area/blob/main/javascript/asynchronous/workers/finished 查看完成后的版本，并且在 https://mdn.github.io/learning-area/javascript/asynchronous/workers/finished 进行在线尝试。\n我们刚刚创建的 worker 被称为 dedicated worker。这意味着它由一个脚本实例使用。\n不过，还有其他类型的 worker：\nSharedWorker 可以由运行在不同窗口中的多个不同脚本共享。 Service worker 的行为就像代理服务器，缓存资源以便于 web 应用程序可以在用户离线时工作。他们是渐进式 Web 应用 的关键组件。 ","wordCount":"1050","inLanguage":"en","image":"https://aikenh.cn/cover/cover12.jpeg","datePublished":"2024-05-01T06:22:33Z","dateModified":"2024-05-01T06:22:33Z","author":[{"@type":"Person","name":"aikenhong"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://aikenh.cn/hugotest/posts/learnweb21-js06-%E5%BC%82%E6%AD%A5js/"},"publisher":{"@type":"Organization","name":"aiken's blog","logo":{"@type":"ImageObject","url":"https://aikenh.cn/favicon/ghost.ico"}}}</script></head><body id=top><script type=module src=https://cdn.jsdmirror.com/npm/ionicons@7.1.0/dist/ionicons/ionicons.esm.js defer></script><script nomodule src=https://cdn.jsdmirror.com/npm/ionicons@7.1.0/dist/ionicons/ionicons.js defer></script><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://aikenh.cn/hugotest/ accesskey=h title="aiken's blog (Alt + H)">aiken's blog</a><div class=logo-switches><button id=theme-toggle-nav accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://aikenh.cn/hugotest/ title=home><span>home</span></a></li><li><a href=https://aikenh.cn/hugotest/posts/ title=posts><span>posts</span></a></li><li><a href=https://aikenh.cn/hugotest/tags/ title=tags><span>tags</span></a></li><li><a href=https://aikenh.cn/hugotest/categories/ title=categories><span>categories</span></a></li><li><a href=https://aikenh.cn/hugotest/archives/ title=archives><span>archives</span></a></li><li><a href=https://aikenh.cn/hugotest/about/ title=about><span>about</span></a></li><li><a href=https://aikenh.cn/hugotest/search title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><div class=sidebar><ul><li class=logo style=--bg:#333><a href=#><div class=logo-icon><img src=/logo/logo.png></div><div class=logo-text>Aiken's Blog</div></a></li><div class=menulist><li style=--bg:#f44336><a href=https://aikenh.cn/hugotest/ title=home><div class=logo-icon><ion-icon name=home-outline></ion-icon></div><div class=logo-text>home</div></a></li><li style=--bg:#b145e9><a href=https://aikenh.cn/hugotest/posts/ title=posts><div class=logo-icon><ion-icon name=newspaper-outline></ion-icon></div><div class=logo-text>posts</div></a></li><li style=--bg:#0f93c7><a href=https://aikenh.cn/hugotest/tags/ title=tags><div class=logo-icon><ion-icon name=pricetags-outline></ion-icon></div><div class=logo-text>tags</div></a></li><li style=--bg:#ffa117><a href=https://aikenh.cn/hugotest/categories/ title=categories><div class=logo-icon><ion-icon name=grid-outline></ion-icon></div><div class=logo-text>categories</div></a></li><li style=--bg:#0fc70f><a href=https://aikenh.cn/hugotest/archives/ title=archives><div class=logo-icon><ion-icon name=folder-outline></ion-icon></div><div class=logo-text>archives</div></a></li><li style=--bg:#d16111><a href=https://aikenh.cn/hugotest/about/ title=about><div class=logo-icon><ion-icon name=person></ion-icon></div><div class=logo-text>about</div></a></li><li style=--bg:#15c095><a href=https://aikenh.cn/hugotest/search title="search (Alt + /)" accesskey=/><div class=logo-icon><ion-icon name=search></ion-icon></div><div class=logo-text>search</div></a></li></div><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt +T)"><li><div class=logo-icon id=moon><ion-icon name=moon-outline></ion-icon></div><div class=logo-icon id=sun><ion-icon name=sunny-outline></ion-icon></div></li></button></div></ul></div><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://aikenh.cn/hugotest/>Home</a>&nbsp;»&nbsp;<a href=https://aikenh.cn/hugotest/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">LearnWeb21-JS06-异步JS</h1><div class=post-meta><span title='2024-05-01 06:22:33 +0000 UTC'>May 1, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1050 words&nbsp;·&nbsp;aikenhong&nbsp;·&nbsp;<a href=/tags/notdone> NotDone</a>&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/LearnWeb21-JS06-%e5%bc%82%e6%ad%a5JS.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://aikenh.cn/cover/cover12.jpeg alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%9f%ba%e4%ba%8e%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86%e7%a8%8b%e5%ba%8f%e5%ae%9e%e7%8e%b0%e5%bc%82%e6%ad%a5 aria-label=基于事件处理程序实现异步>基于事件处理程序实现异步</a></li><li><a href=#promise-%e7%8e%b0%e4%bb%a3-js-%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b%e7%9a%84%e5%9f%ba%e7%a1%80 aria-label="Promise 现代 JS 异步编程的基础">Promise 现代 JS 异步编程的基础</a><ul class=header-level-2><li><a href=#%e4%bb%a5-fetch-%e4%b8%ba%e4%be%8b aria-label="以 fetch() 为例">以 fetch() 为例</a></li><li><a href=#%e9%93%be%e5%bc%8f%e4%bd%bf%e7%94%a8-promise aria-label="链式使用 Promise">链式使用 Promise</a></li><li><a href=#%e5%a4%84%e7%90%86%e5%bc%82%e5%b8%b8%e8%bf%94%e5%9b%9e%e5%80%bc aria-label=处理异常返回值>处理异常返回值</a></li><li><a href=#promise-%e7%9a%84%e7%8a%b6%e6%80%81%e5%80%bc aria-label="Promise 的状态值">Promise 的状态值</a></li><li><a href=#%e7%bb%84%e5%bc%8f%e4%bd%bf%e7%94%a8-promise-%e5%90%88%e5%b9%b6%e4%bd%bf%e7%94%a8 aria-label="组式使用 Promise (合并使用)">组式使用 Promise (合并使用)</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bd%bf%e7%94%a8-promise-%e4%bb%bb%e4%b8%80 aria-label="选择使用 Promise (任一)">选择使用 Promise (任一)</a></li></ul></li><li><a href=#async-%e5%92%8c-await aria-label="async 和 await">async 和 await</a></li><li><a href=#promise-%e5%ae%9e%e6%88%98 aria-label="Promise 实战">Promise 实战</a></li><li><a href=#workers-%e9%a1%b5%e9%9d%a2%e7%ba%bf%e7%a8%8b%e7%ae%80%e4%bb%8b aria-label="Workers 页面线程简介">Workers 页面线程简介</a></li></ul></div></details></div></aside><script>let activeElement,elements;document.addEventListener("DOMContentLoaded",function(){if(checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),elements.length>0){activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")}const t=document.getElementById("top-link");t&&t.addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{const e=window.pageYOffset||document.documentElement.scrollTop;if(e===0)return;elements&&elements.length>0&&(elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase(),n=document.querySelector(`.inner ul li a[href="#${t}"]`);n.classList.remove("read")}),activeElement=Array.from(elements).find(t=>{if(getOffsetTop(t)-e>0&&getOffsetTop(t)-e<window.innerHeight/2)return t})||activeElement,elements.forEach((t)=>{const o=encodeURI(t.getAttribute("id")).toLowerCase(),s=document.querySelector(`.inner ul li a[href="#${o}"]`);if(t===activeElement){s.classList.add("active");const e=document.querySelector(".toc .inner"),t=s.offsetTop,n=e.clientHeight,o=s.clientHeight,i=t-n/2+o/2;e.scrollTo({top:i,behavior:"smooth"})}else getOffsetTop(t)<e&&s.classList.add("read"),s.classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return!document.querySelector(".hugo-encryptor-prompt")&&elements.length!=0&&(elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),console.log("Elements re-queried:",elements)),0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote class="alert-blockquote alert-summary"><p class=alert-heading><svg viewBox="0 0 16 16" width="16" height="16"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>
<span>Summary</span></p><p>如果页面的功能较为复杂，且涉及到了从服务端获取数据等操作，如果简单的使用同步编程，等待一个个任务按顺序执行，由于网络或者某些时间复杂度较高的操作，导致网页加载时间过长，或者使用逻辑不合理（加载某些资源的同时无法进行浏览等），因此异步编程的特性在 web 端是十分重要的。</p></blockquote><p>通过<strong>异步编程</strong>使一个长时间运行的任务运行的同时能够对网页做出其他的操作和对其他事件做出相应，而不需等待该任务完成，以下的这些功能就是最常见需要异步完成的；</p><ul><li><code>fetch</code> 发起 http 请求</li><li><code>getUserMedia()</code> 获取用户的摄像头和麦克风</li><li><code>showOpenFilePicker()</code> 请求用户选择文件以供访问。</li></ul><h2 id=基于事件处理程序实现异步>基于事件处理程序实现异步<a hidden class=anchor aria-hidden=true href=#基于事件处理程序实现异步>#</a></h2><blockquote><p>事件处理的逻辑实际上也是一种接近异步编程的方式，对应的函数不是即时执行，而是等事件被触发后在进行调用。一些早期的异步 API 就是这样使用事件的。</p></blockquote><p>一些早期的异步 API 就是这样来使用事件，例如 <code>XMLHttpRequest</code> 可以使用 JS 向远程服务器发起 HTTP 请求，这类网络请求操作都会比较耗时，因此通常会使用异步，以下面的例子进行后续说明；</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>log</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;.event-log&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#xhr&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=err>）</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kr>const</span> <span class=nx>xhr</span>  <span class=o>=</span> <span class=k>new</span> <span class=nx>XMLHttpRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nx>xhr</span><span class=p>.</span><span class=nx>addEvenetLister</span><span class=p>(</span><span class=s2>&#34;loadend&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>log</span><span class=p>.</span><span class=nx>textContent</span><span class=si>}</span><span class=sb> 完成, 状态码: </span><span class=si>${</span><span class=nx>xhr</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=nx>xhr</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;https://URL/dir/file.json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nx>xhr</span><span class=p>.</span><span class=nx>send</span><span class=p>()</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>log</span><span class=p>.</span><span class=nx>textContent</span><span class=si>}</span><span class=sb> 请求已发起\n`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p><code>xhr</code> 按钮点击后，声明一个 <code>XMLHttpRequest</code> 对象，并监听其 <code>loadend</code> 事件，然后发送请求，并将字符串修改为请求已发起，该字符串会在触发了 <code>loadend</code> 加载完了请求事件后改为，已完成。</p><blockquote><p>事件处理程序本身是一种特殊类型的回调函数（函数作为参数传递到另一个函数），多层回调函数的嵌套会导致代码难以理解和 debug，因此后面大多数 API 不在使用回调函数去处理异步的情况。</p></blockquote><h2 id=promise-现代-js-异步编程的基础>Promise 现代 JS 异步编程的基础<a hidden class=anchor aria-hidden=true href=#promise-现代-js-异步编程的基础>#</a></h2><blockquote><p><strong>Promise</strong> 是现代 JavaScript 中异步编程的基础。它是一个由异步函数返回的对象，可以指示操作当前所处的状态。在 Promise 返回给调用者的时候，操作往往还没有完成，但 Promise 对象提供了方法来处理操作最终的成功或失败。</p></blockquote><p>一个基于 <code>Promise</code> 的 API，异步函数会启动操作并直接返回一个 <a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise target=_blank rel=noopener><code>Promise</code></a>
对象，可以将后续的处理函数附加到该对象上，当操作完成时（成功、失败），执行对应的处理函数。</p><h3 id=以-fetch-为例>以 fetch() 为例<a hidden class=anchor aria-hidden=true href=#以-fetch-为例>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>fetchPromise</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fetchPromise</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`已受到响应 </span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;已发送请求...&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Promise { &lt;state&gt;: &#34;pending&#34;}
</span></span></span></code></pre></td></tr></table></div></div><ol><li>调用 <code>fetch()</code> 将返回的 <code>promise</code> 存储到 <code>fetchPromise</code> 变量</li><li><code>Promise</code> 的变量输出结果如下</li><li>将处理函数传递给 promise 变量的 then 函数，当 fetch 操作成功的时候，promise 就会调用对应的处理函数。</li></ol><p>整体的处理逻辑还是比较清晰的，关键是使用 promise 变量的 then 函数去处理 fetch 的各种不同结果。</p><h3 id=链式使用-promise>链式使用 Promise<a hidden class=anchor aria-hidden=true href=#链式使用-promise>#</a></h3><p>在前面通过 fetch 获取 response 对象的时候，我们需要使用对应的 <code>json()</code> 方法将其转换为 js 专属的对象，这里的 json 实际上也是一个异步方法，由此我们可以链式的实现异步如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fetchPromisze</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kr>const</span> <span class=nx>jsonPromise</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nx>jsonPromise</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>json</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>json</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>这种情况在多层嵌套的时候也会堆叠得很难理解，但是相比于回调函数，每一级的回调都会有个 promise 的<strong>即时返回值</strong>来指示对应异步函数中的完成状态。</p><p>由于 <code>promise</code> 是一个<strong>即时返回值</strong>，因此上述的代码可以简写为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>fetchPromise</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>不必在第一个 then 中调用下一个 then，可以直接返回对应的 promise 对象，对对应的 promise 对象调用处理即可，这样可以避免多级缩进叠加；</p><h3 id=处理异常返回值>处理异常返回值<a hidden class=anchor aria-hidden=true href=#处理异常返回值>#</a></h3><p>对 <code>promise</code> 中的状态值进行检查，如果状态码不是 ok 就需要对应的抛出错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fetchPromise</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`HTTP 请求错误 </span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>json</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>json</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>});</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></td></tr></table></div></div><p>此外由于这种异步的函数返回机制，如果要按照上面的方式逐个进行错误处理非常的困难，需要在每个嵌套层中进行处理，为了避免这种麻烦，Promise 对象提供了一个 <code>catch()</code> 方法（类似 then），当调用成功时触发的是 <code>then</code> 而调用失败了就会调用 <code>catch</code> 中定义的处理函数。</p><p>将 <code>catch</code> 添加到 <code>Promise</code> 的末尾，他可以在任何异步函数失败的时候调用，下面是一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bad-scheme://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fetchPromise</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`HTTP 请求错误：</span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>json</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>json</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=sb>`无法获取产品列表：</span><span class=si>${</span><span class=nx>error</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=promise-的状态值>Promise 的状态值<a hidden class=anchor aria-hidden=true href=#promise-的状态值>#</a></h3><blockquote><p>需要注意 <code>promise</code> 对应的成功和失败的含义随着 API 的不同而不同，例如 <code>fetch</code> 认为服务器返回一个错误如（404 not found）时请求成功，但如果网络错误阻止请求被发送，则认为请求失败。</p></blockquote><table><thead><tr><th style=text-align:left>Status</th><th style=text-align:center>Desc</th></tr></thead><tbody><tr><td style=text-align:left>Pending 待定</td><td style=text-align:center>还在请求中，尚未有确定的结果，也是初始状态</td></tr><tr><td style=text-align:left>fulfilled 已兑现</td><td style=text-align:center>操作成功的标准返回，后续进入调用 then 的逻辑</td></tr><tr><td style=text-align:left>rejected 已拒绝</td><td style=text-align:center>操作失败的标准返回，后续进入调用 catch 的逻辑</td></tr></tbody></table><p>有时用**已敲定(settled)<strong>来同时表示已兑现和已拒绝；如果一个 Promise 已敲定，或者他被"锁定"以跟踪另一个 Promise 的状态，那么就是</strong>已解决(resolved)**的。</p><h3 id=组式使用-promise-合并使用>组式使用 Promise (合并使用)<a hidden class=anchor aria-hidden=true href=#组式使用-promise-合并使用>#</a></h3><blockquote><p>当操作由多个异步函数组成，如果需要串行完成那就需要 promise 链，如果需要组合使用多个 promise，相互之间不依赖但是需要所有 promise 都实现的情况，可以考虑合并多个异步函数的使用。</p></blockquote><p>使用 <code>Promise.all()</code> 接受一个 <code>Promise</code> 数组，并返回一个单一的 <code>Promise</code>，使用该操作通过合并来简化对一批 <code>promise</code> 的处理，由 <code>promise.all()</code> 返回的 <code>promise</code> 有以下的特性：</p><ul><li>什么时候调用 then？当数组中所有 promise 都兑现时;</li><li>传入 then 的形式式什么？提供一个包含所有响应的数组，顺序与传入 all 的顺序一致;</li><li>什么时候拒绝/调用catch？任何一个promise 没有兑现的时候，调用 <code>catch</code>，并提供被拒绝的 promise 抛出的错误;</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise1</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise2</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/not-found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fetchPromise3</span> <span class=o>=</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;https://mdn.github.io/learning-area/javascript/oojs/json/superheroes.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//const fetchPromise3 = fetch(
</span></span></span><span class=line><span class=cl><span class=c1>//  &#34;bad-scheme://mdn.github.io/learning-area/javascript/oojs/json/superheroes.json&#34;,
</span></span></span><span class=line><span class=cl><span class=c1>//);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span><span class=nx>fetchPromise1</span><span class=p>,</span> <span class=nx>fetchPromise2</span><span class=p>,</span> <span class=nx>fetchPromise3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>responses</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>response</span> <span class=k>of</span> <span class=nx>responses</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>url</span><span class=si>}</span><span class=sb>：</span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=sb>`获取失败：</span><span class=si>${</span><span class=nx>error</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=选择使用-promise-任一>选择使用 Promise (任一)<a hidden class=anchor aria-hidden=true href=#选择使用-promise-任一>#</a></h3><p>如果需要一组Promise 中某一个实现即可，这种时候可以使用 <code>promise.any()</code>, 任意一个被兑现时便兑现，仅当所有 Promise 被拒绝的时候才拒绝。</p><h2 id=async-和-await>async 和 await<a hidden class=anchor aria-hidden=true href=#async-和-await>#</a></h2><p>在函数的开头添加 <code>async</code> 关键词可以使得一个函数成为一个异步函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>myFunction</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>await</code> 关键词则使得我们不再并行执行异步函数，而是在原地等待该异步函数执行完成，也就是讲异步函数当成同步函数来使用，直到其 Promise 相应彻底完成，如下可以将 fetch 改写成同步函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>fetchProducts</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 在这一行之后，我们的函数将等待 `fetch()` 调用完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 调用 `fetch()` 将返回一个“响应”或抛出一个错误
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;https://mdn.github.io/learning-area/javascript/apis/fetching-data/can-store/products.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`HTTP 请求错误：</span><span class=si>${</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 在这一行之后，我们的函数将等待 `response.json()` 的调用完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// `response.json()` 调用将返回 JSON 对象或抛出一个错误
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>json</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>json</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=sb>`无法获取产品列表：</span><span class=si>${</span><span class=nx>error</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fetchProducts</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>这个 <code>fetchProducts()</code> 还是一个异步函数，因此不能按照以下的方法调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>promise</span> <span class=o>=</span> <span class=nx>fetchProducts</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>promise</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>);</span> <span class=c1>// “promise”是一个 Promise 对象，因此这句代码无法正常工作
</span></span></span></code></pre></td></tr></table></div></div><p>相反的，需要按照 promise 的方式去调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>promise</span> <span class=o>=</span> <span class=nx>fetchProducts</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>promise</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>name</span><span class=p>));</span>
</span></span></code></pre></td></tr></table></div></div><p>同样地，请注意你只能在 <code>async</code> 函数中使用 <code>await</code>，除非你的代码是 <a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules target=_blank rel=noopener>JavaScript 模块</a>
。这意味着你不能在普通脚本中这样做：</p><p>你可能会在需要使用 Promise 链地方使用 <code>async</code> 函数，这也使得 Promise 的工作更加直观。</p><p>请记住，就像一个 Promise 链一样，<code>await</code> 强制异步操作以串联的方式完成。如果下一个操作的结果取决于上一个操作的结果，这是必要的，但如果不是这样，像 <code>Promise.all()</code> 这样的操作会有更好的性能。</p><h2 id=promise-实战>Promise 实战<a hidden class=anchor aria-hidden=true href=#promise-实战>#</a></h2><blockquote><p>前面讨论<strong>如何使用返回</strong> promise 的 APIs，这一节研究<strong>如何实现返回</strong> Promise 的 Apis，这与基于使用 promise 的 APIs 相比，是一个不太常见的任务。参考文献 <a href=https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Implementing_a_promise-based_API target=_blank rel=noopener>mdn如何实现基于promise的api</a>
| <a href=https://www.runoob.com/js/js-promise.html target=_blank rel=noopener>菜鸟教程JavaScript Promise</a>
| <a href=https://www.liaoxuefeng.com/wiki/1022910821149312/1023024413276544 target=_blank rel=noopener>廖雪峰JavaScript</a></p></blockquote><p>以一个普通的回调转换为 Promise 的例子来说明：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>output</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#output&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>button</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#set-alarm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>setAlarm</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>window</span><span class=p>.</span><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>output</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=s2>&#34;Wake up!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>button</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=nx>setAlarm</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>利用 Promise 来构造后会变成如下的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>alarm</span><span class=p>(</span><span class=nx>person</span><span class=p>,</span> <span class=nx>delay</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>delay</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s2>&#34;Alarm delay must not be negative&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>resolve</span><span class=p>(</span><span class=sb>`Wake up, </span><span class=si>${</span><span class=nx>person</span><span class=si>}</span><span class=sb>!`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>delay</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该函数会创建并返回一个新的 Promise，其中需要说明的是，Promise 本身需要两个参数 resolve 和 reject，当执行成功了就会调用 resolve（类似 return），如果失败了，就会自动调用 reject，（throw error 的部分），两者都可以讲任何类型的单个参数传递，具体而言参考后续调用如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>button</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>alarm</span><span class=p>(</span><span class=nx>name</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>delay</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>output</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>message</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>output</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=sb>`Couldn&#39;t set alarm: </span><span class=si>${</span><span class=nx>error</span><span class=si>}</span><span class=sb>`</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>可以讲一个函数变成具备原生异步功能的 Promise？由此我们就可以对其使用 await 或者 async 来灵活的决定该 Function 要同步或者异步执行。</p><h2 id=workers-页面线程简介>Workers 页面线程简介<a hidden class=anchor aria-hidden=true href=#workers-页面线程简介>#</a></h2><blockquote class="alert-blockquote alert-summary"><p class=alert-heading><svg viewBox="0 0 16 16" width="16" height="16"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>
<span>Summary</span></p><p><a href=https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Introducing_workers target=_blank rel=noopener>Worker</a>
使页面能在单独执行的线程中运行一些任务，避免因为一个长期运行的同步任务使整个任务完全没有响应。</p></blockquote><p>一些多线程的 Principle，避免同时访问相同的变量带来的意外等：</p><ul><li>主代码和你的 worker 代码永远不能直接访问彼此的变量</li><li>Workers 和主代码运行在完全分离的环境中，只有通过相互发送消息来进行交互</li><li>这意味着 workers 不能访问 DOM（窗口、文档、页面元素等等）</li></ul><p>有三种不同类型的 workers，不过该章节只会介绍第一个，其他两个简要的讨论。</p><ul><li>dedicated workers</li><li>shared workers</li><li>service workers</li></ul><p>以页面中的质数生成器为例，如果作为同步任务执行，在计算过程中整个页面将会卡住，按照以下的方式来讲计算交付于另一个 worker。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 在 &#34;generate.js&#34; 中创建一个新的 worker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=s2>&#34;./generate.js&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 当用户点击 &#34;Generate primes&#34; 时，给 worker 发送一条消息。
</span></span></span><span class=line><span class=cl><span class=c1>// 消息中的 command 属性是 &#34;generate&#34;, 还包含另外一个属性 &#34;quota&#34;，即要生成的质数。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#generate&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>quota</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#quota&#34;</span><span class=p>).</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=s2>&#34;generate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>quota</span><span class=o>:</span> <span class=nx>quota</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 当 worker 给主线程回发一条消息时，为用户更新 output 框，包含生成的质数（从 message 中获取）。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#output&#34;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=sb>`Finished generating </span><span class=si>${</span><span class=nx>message</span><span class=p>.</span><span class=nx>data</span><span class=si>}</span><span class=sb> primes!`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#reload&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#user-input&#34;</span><span class=p>).</span><span class=nx>value</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Try typing in here immediately after pressing &#34;Generate primes&#34;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>reload</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 worker.postMessage 来和对应的线程传递信息，在对应的 worker 中，可以按照以下的方式来接受和传递信息；</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 监听主线程中的消息。
</span></span></span><span class=line><span class=cl><span class=c1>// 如果消息中的 command 是 &#34;generate&#34;，则调用 `generatePrimse()`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>command</span> <span class=o>===</span> <span class=s2>&#34;generate&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>generatePrimes</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>quota</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 生成质数 (非常低效)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>generatePrimes</span><span class=p>(</span><span class=nx>quota</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>isPrime</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>c</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=nx>c</span> <span class=o>&lt;=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>sqrt</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span> <span class=o>++</span><span class=nx>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>n</span> <span class=o>%</span> <span class=nx>c</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>primes</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>maximum</span> <span class=o>=</span> <span class=mi>1000000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>primes</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=nx>quota</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>candidate</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=p>(</span><span class=nx>maximum</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isPrime</span><span class=p>(</span><span class=nx>candidate</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>primes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>candidate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 完成后给主线程发送一条包含我们生成的质数数量的消息消息。
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>postMessage</span><span class=p>(</span><span class=nx>primes</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>worker 要做的第一件事情就是开始监听来自主脚本的消息。这通过使用 <code>addEventListener()</code> 实现，它在 worker 中是一个全局函数。在 <code>message</code> 事件处理器内部，事件的 <code>data</code> 属性包含一个来自主脚本的参数的副本。</p><blockquote class="alert-blockquote alert-note"><p class=alert-heading><svg viewBox="0 0 16 16" width="16" height="16"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>
<span>Note</span></p><p>**备注：**要运行此站点，你必须运行一个本地 web 服务器，因为 file:// URLs 不允许加载 workers。参考我们的<a href=https://developer.mozilla.org/zh-CN/docs/Learn/Common_questions/Tools_and_setup/set_up_a_local_testing_server target=_blank rel=noopener>设置一个本地测试服务器</a>
的指导。完成后，你应该可以点击 &ldquo;Generate primes&rdquo; 并且使你的主页面保持响应。 如果你在创建和运行这个样例的过程中有疑问，你可以在 <a href=https://github.com/mdn/learning-area/blob/main/javascript/asynchronous/workers/finished target=_blank rel=noopener>https://github.com/mdn/learning-area/blob/main/javascript/asynchronous/workers/finished</a>
 查看完成后的版本，并且在 <a href=https://mdn.github.io/learning-area/javascript/asynchronous/workers/finished target=_blank rel=noopener>https://mdn.github.io/learning-area/javascript/asynchronous/workers/finished</a>
 进行在线尝试。</p></blockquote><p>我们刚刚创建的 worker 被称为 <em>dedicated worker</em>。这意味着它由一个脚本实例使用。</p><p>不过，还有其他类型的 worker：</p><ul><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/SharedWorker target=_blank rel=noopener><code>SharedWorker</code></a>
 可以由运行在不同窗口中的多个不同脚本共享。</li><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API target=_blank rel=noopener><em>Service worker</em></a>
 的行为就像代理服务器，缓存资源以便于 web 应用程序可以在用户离线时工作。他们是<a href=https://developer.mozilla.org/zh-CN/docs/Web/Progressive_web_apps target=_blank rel=noopener>渐进式 Web 应用</a>
的关键组件。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://aikenh.cn/hugotest/tags/notdone/>NotDone</a></li></ul><nav class=paginav><a class=prev href=https://aikenh.cn/hugotest/posts/ts1_%E5%A4%B4%E6%96%87%E4%BB%B6%E4%BA%92%E7%9B%B8%E5%8C%85%E5%90%AB/><span class=title>« Prev</span><br><span>CPP_头文件互相包含</span>
</a><a class=next href=https://aikenh.cn/hugotest/posts/learnweb20-js05-json%E4%BD%BF%E7%94%A8/><span class=title>Next »</span><br><span>LearnWeb20-JS05-JSON使用</span></a></nav></footer><div id=disqus_thread></div><script>function loadDisqus(){var e=document,t=e.createElement("script");t.src="https://aiken-hugo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t),window.disqus_config=function(){this.page.url=window.location.href,this.page.identifier=window.location.href.substring(18)}}var runningOnBrowser=typeof window!="undefined",isBot=runningOnBrowser&&!("onscroll"in window)||typeof navigator!="undefined"&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout(function(){if(!isBot&&supportsIntersectionObserver){var e=new IntersectionObserver(function(t){t[0].isIntersecting&&(loadDisqus(),e.disconnect())},{threshold:[0]});e.observe(document.getElementById("disqus_thread"))}else loadDisqus()},1)</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2024 <a href=https://aikenh.cn/hugotest/>aiken's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container>Visitors: <span id=busuanzi_value_site_uv></span>
Views: <span id=busuanzi_value_site_pv></span></span></footer><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("busuanzi_value_site_uv"),t=document.getElementById("busuanzi_value_site_pv"),o=13863,i=16993;if(!e||!t){console.error("Busuanzi elements not found.");return}const n=new MutationObserver(e=>{for(let t of e)if(t.type==="childList"){n.disconnect(),t.target.innerHTML=parseInt(t.target.innerHTML||0)+o;break}}),s=new MutationObserver(e=>{for(let t of e)if(t.type==="childList"){s.disconnect(),t.target.innerHTML=parseInt(t.target.innerHTML||0)+i;break}});n.observe(e,{childList:!0}),s.observe(t,{childList:!0})})</script><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))}),document.getElementById("theme-toggle-nav").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("/js/pangu.js",function(){pangu.spacingPage()})</script></body></html>